<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Administración</title>
  <!-- FUENTES AÑADIDAS -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans&display=swap" rel="stylesheet">
  <!-- Chart.js para las métricas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <a href="index.html" style="position:fixed; top:20px; right:20px; color:white; text-decoration:none; z-index:20; font-weight:bold; text-shadow:0 1px 3px rgba(0,0,0,0.5);">Salir</a>
  
  <style>
    /* === ESTILOS GENERALES (INTACTOS) === */
    body {
      font-family: 'Open Sans', Arial, sans-serif;
      margin: 0;
      background: linear-gradient(rgba(0,0,0,0.38), rgba(0,0,0,0.38)),
        url('https://cdn.pixabay.com/photo/2023/09/04/20/39/cake-8233676_1280.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #333;
    }

    header {
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(4px);
      color: #fff;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    header h1 {
      font-family: 'Playfair Display', serif;
      margin: 0;
    }

    .botones {
      display: flex;
      justify-content: center;
      margin: 30px 0;
      gap: 20px;
      flex-wrap: wrap;
    }

    .botones button {
      padding: 15px 30px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(90deg,#d6001c,#a30015);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: filter 0.2s;
    }

    .botones button:hover {
      filter: brightness(0.9);
    }

    #contenido {
      max-width: 1200px;
      margin: 28px auto;
      background-color: #ffffff;
      color: #333;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      min-height: 400px;
    }

    .titulo-contenido {
      font-family: 'Playfair Display', serif;
      font-size: 24px;
      margin-bottom: 20px;
      color: #b33f4f;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #f4bebe; color: #333; }
    tr:nth-child(even) { background-color: #fdf3f3; }

    .acciones button {
      padding: 6px 12px; margin: 0 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;
    }
    .btn-editar { background-color: #FFA000; color: white; }
    .btn-eliminar { background-color: #C62828; color: white; }

    /* Estilos Gestión Pedidos (RESTAURADOS) */
    .admin-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
    @media (max-width: 900px) { .admin-layout { grid-template-columns: 1fr; } }
    .pedidos-lista-cont { background: #fff5f5; border-radius: 8px; padding: 15px; max-height: 700px; overflow-y: auto; border: 1px solid #ffdada; }
    .pedido-card-mini { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
    .pedido-card-mini:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .pedido-card-mini.active { border-left-color: #d6001c; background: #fffbfb; box-shadow: 0 4px 15px rgba(214,0,28,0.1); }
    .pedido-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; color: #333; }
    .pedido-meta { display: flex; justify-content: space-between; font-size: 0.85rem; color: #666; }
    .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; color: white; font-weight: bold; }
    .bg-recibido { background-color: #a30015; }
    .bg-proceso { background-color: #f4a261; }
    .bg-camino { background-color: #2a9d8f; }
    .bg-entregado { background-color: #28a745; }
    .pedido-detalle { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
    .timeline-step { display: flex; margin-bottom: 15px; }
    .timeline-bullet { width: 12px; height: 12px; border-radius: 50%; background: #ddd; margin-right: 10px; margin-top: 5px; }
    .timeline-step.active .timeline-bullet { background: #d6001c; box-shadow: 0 0 0 3px rgba(214,0,28,0.2); }

    /* Estilos Métricas */
    .kpis { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 12px; }
    @media (max-width:920px){ .kpis{grid-template-columns: repeat(2,1fr)} }
    .kpi { background: linear-gradient(90deg, rgba(214,0,28,0.06), rgba(214,0,28,0.02)); border-radius: 12px; padding: 12px; }
    .kpi .value { font-size: 1.4rem; font-weight: 800; color: #a30015; }
    .kpi .label { color: #666; font-size: 0.9rem; }
    .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px; }
    .chart-wrap { padding: 12px; border-radius: 10px; background: #fff; border: 1px solid #eee; height: 300px; }

    /* Formularios Edición */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
    .modal-contenido { background: #ffffff; color: #333; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); font-family: 'Open Sans', sans-serif; }
    .modal-contenido h2 { font-family: 'Playfair Display', serif; color: #b33f4f; text-align: center; margin-top: 0; }
    .modal-contenido label { display: block; margin-top: 15px; font-weight: bold; }
    .modal-contenido input, .modal-contenido textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-top: 5px; }
    .modal-botones { margin-top: 25px; text-align: center; display: flex; justify-content: center; gap: 10px; }

    /* === ESTILOS MODAL NOTIFICACIÓN (NUEVO DISEÑO ACORDE A IMAGEN) === */
    .custom-modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 3000; /* Z-index superior para evitar que otros modales lo tapen */
      display: none; justify-content: center; align-items: center;
      backdrop-filter: blur(2px); opacity: 0; transition: opacity 0.3s ease;
    }
    .custom-modal-overlay.open { display: flex; opacity: 1; }
    
    .custom-modal-box {
      background: white; 
      padding: 35px 30px; 
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 380px; 
      width: 90%; 
      text-align: center;
      transform: translateY(20px); 
      transition: transform 0.3s ease;
      position: relative;
    }
    .custom-modal-overlay.open .custom-modal-box { transform: translateY(0); }

    /* Icono X o Check */
    .custom-modal-icon { 
      font-size: 4rem; 
      margin-bottom: 10px; 
      display: block;
      line-height: 1;
    }
    
    /* Título Serif Rojo Oscuro */
    .custom-modal-title { 
      font-size: 1.8rem; 
      font-weight: 700; 
      margin-bottom: 10px; 
      color: #9e0e23; /* Rojo oscuro similar al de la imagen */
      font-family: 'Playfair Display', serif; 
    }
    
    /* Texto gris */
    .custom-modal-msg { 
      font-size: 1rem; 
      margin-bottom: 25px; 
      color: #666; 
      line-height: 1.5; 
      font-family: 'Open Sans', sans-serif;
    }
    
    /* Botonera */
    .custom-modal-actions { 
      display: flex; 
      justify-content: center; 
      gap: 15px; 
    }
    
    /* Botón Rojo Redondeado (Estilo Entendido/Aceptar) */
    .custom-btn {
      padding: 12px 35px; 
      border: none; 
      border-radius: 8px;
      font-weight: 700; 
      cursor: pointer; 
      transition: all 0.2s; 
      font-size: 1rem;
      font-family: 'Open Sans', sans-serif;
      width: 100%; /* Para botones de acción única como "Entendido" */
    }
    
    .btn-modal-confirm { 
      background-color: #c90d2d; /* Rojo fuerte similar a la imagen */
      color: white; 
      box-shadow: 0 4px 10px rgba(201, 13, 45, 0.3);
    }
    .btn-modal-confirm:hover { 
      background-color: #a30015; 
      transform: translateY(-2px);
    }
    
    .btn-modal-cancel { 
      background-color: #f0f0f0; 
      color: #555; 
    }
    .btn-modal-cancel:hover { background-color: #e0e0e0; }

  </style>
</head>
<body>

<header>
  <h1>Panel del Administrador</h1>
</header>

<div class="botones">
  <button onclick="mostrarProductos()">Gestión de Productos</button>
  <button onclick="mostrarFormularioAgregarPostre()">Agregar Postre</button>
  <button onclick="mostrarUsuarios()">Gestión de Usuarios</button>
  <button onclick="mostrarMetricas()">Ver Métricas</button>
  <button onclick="mostrarSeguimiento()">Gestión de Pedidos</button>
</div>

<div id="contenido">
  <p class="titulo-contenido" style="text-align:center;">Selecciona una opción para comenzar</p>
</div>

<!-- ========================================== -->
<!-- MODALES DE EDICIÓN (Formularios) -->
<!-- ========================================== -->
<div id="modalEditar" class="modal-overlay">
  <div class="modal-contenido">
    <h2>Editar Receta</h2>
    <form id="formEditarPostre">
      <input type="hidden" id="editar_id" name="id">
      <label>Título</label><input type="text" id="editar_titulo" name="titulo" required>
      <label>Descripción</label><textarea id="editar_descripcion" name="descripcion" rows="3" required></textarea>
      <label>Precio</label><input type="number" step="0.01" id="editar_precio" name="precio" required>
      <label>Categoría</label><input type="text" id="editar_categoria" name="categoria">
      <label>Tamaño</label><input type="text" id="editar_tamanio" name="tamanio">
      <label>Sabor</label><input type="text" id="editar_sabor" name="sabor">
      <label>URL Imagen</label><input type="text" id="editar_imagen_url" name="imagen_url">
      <label>Stock</label><input type="number" id="editar_stock" name="stock">
      <div class="modal-botones">
        <button type="submit" class="btn-editar">Guardar</button>
        <button type="button" class="btn-eliminar" onclick="cerrarModalesEdicion()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<div id="modalEditarUsuario" class="modal-overlay">
  <div class="modal-contenido">
    <h2>Editar Usuario</h2>
    <form id="formEditarUsuario">
      <input type="hidden" id="usuario_id" name="id">
      <label>Correo</label><input type="email" id="usuario_correo" name="correo" required>
      <label>Contraseña</label><input type="text" id="usuario_pass" name="pass" required>
      <div class="modal-botones">
        <button type="submit" class="btn-editar">Guardar</button>
        <button type="button" class="btn-eliminar" onclick="cerrarModalesEdicion()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- ========================================== -->
<!-- MODAL DE NOTIFICACIÓN (Nuevo Diseño) -->
<!-- ========================================== -->
<div id="custom-modal-overlay" class="custom-modal-overlay">
  <div class="custom-modal-box">
    <div id="custom-modal-icon" class="custom-modal-icon"></div>
    <div id="custom-modal-title" class="custom-modal-title"></div>
    <div id="custom-modal-msg" class="custom-modal-msg"></div>
    <div id="custom-modal-actions" class="custom-modal-actions"></div>
  </div>
</div>

<script>
  // =========================================
  // 1. SISTEMA DE MODALES PERSONALIZADOS
  // =========================================
  // Función principal para mostrar mensajes (Alerta, Éxito, Error)
  function showModal(message, title = "Aviso", icon = "ℹ️", isError = false) {
    return new Promise(resolve => {
      const overlay = document.getElementById('custom-modal-overlay');
      const titleEl = document.getElementById('custom-modal-title');
      const msgEl = document.getElementById('custom-modal-msg');
      const iconEl = document.getElementById('custom-modal-icon');
      const actions = document.getElementById('custom-modal-actions');

      overlay.style.display = 'flex';
      void overlay.offsetWidth; // Trigger reflow
      overlay.classList.add('open');

      // Estilos según error o éxito (emulando la imagen)
      if (isError) {
        iconEl.innerHTML = '❌'; 
        iconEl.style.color = '#ff4d6d'; // Rosa/Rojo suave para la X
        titleEl.style.color = '#a30015'; // Rojo oscuro para el título
        titleEl.textContent = title || "Error";
      } else {
        iconEl.innerHTML = '✅';
        iconEl.style.color = '#2e7d32'; // Verde para éxito
        titleEl.style.color = '#2e7d32';
        titleEl.textContent = title || "Éxito";
      }
      
      msgEl.innerHTML = message;

      actions.innerHTML = `<button class="custom-btn btn-modal-confirm" id="btn-modal-ok">Entendido</button>`;
      
      document.getElementById('btn-modal-ok').onclick = () => {
        overlay.classList.remove('open');
        setTimeout(() => { overlay.style.display = 'none'; resolve(); }, 300);
      };
    });
  }

  // Función para confirmaciones (Eliminar, Cancelar, etc.)
  function showConfirmation(message, title = "Confirmación") {
    return new Promise(resolve => {
      const overlay = document.getElementById('custom-modal-overlay');
      const titleEl = document.getElementById('custom-modal-title');
      const msgEl = document.getElementById('custom-modal-msg');
      const iconEl = document.getElementById('custom-modal-icon');
      const actions = document.getElementById('custom-modal-actions');

      overlay.style.display = 'flex';
      void overlay.offsetWidth;
      overlay.classList.add('open');

      iconEl.innerHTML = '❓';
      iconEl.style.color = '#a30015';
      titleEl.style.color = '#a30015';
      titleEl.textContent = title;
      msgEl.innerHTML = message;

      actions.innerHTML = `
        <button class="custom-btn btn-modal-cancel" id="btn-modal-no">Cancelar</button>
        <button class="custom-btn btn-modal-confirm" id="btn-modal-yes" style="width:auto;">Sí, continuar</button>
      `; // Botón 'Sí, continuar' más pequeño en confirmación

      document.getElementById('btn-modal-yes').onclick = () => {
        overlay.classList.remove('open');
        setTimeout(() => { overlay.style.display = 'none'; resolve(true); }, 300);
      };
      document.getElementById('btn-modal-no').onclick = () => {
        overlay.classList.remove('open');
        setTimeout(() => { overlay.style.display = 'none'; resolve(false); }, 300);
      };
    });
  }

  function cerrarModalesEdicion() {
    document.getElementById('modalEditar').style.display = 'none';
    document.getElementById('modalEditarUsuario').style.display = 'none';
  }

  // =========================================
  // 2. GESTIÓN DE PEDIDOS (Restaurada - Estática)
  // =========================================
  function mostrarSeguimiento() {
    const html = `
      <p class="titulo-contenido">Gestión de Pedidos</p>
      <div style="margin-bottom:15px;">
        <input type="text" placeholder="Buscar por ID o cliente..." style="width:100%; max-width:400px; padding:10px; border:1px solid #ccc; border-radius:6px;">
      </div>
      
      <div class="admin-layout">
        <!-- Columna Izquierda: Lista (Placeholders Fijos) -->
        <div class="pedidos-lista-cont">
          <div class="pedido-card-mini active" onclick="cargarDetallePedido(923153)">
            <div class="pedido-header"><span>Pedido #923153</span> <span class="status-badge bg-recibido">Recibido</span></div>
            <div class="pedido-meta"><span>Ana García</span> <span>$23.98</span></div>
          </div>
          <div class="pedido-card-mini" onclick="cargarDetallePedido(923152)">
            <div class="pedido-header"><span>Pedido #923152</span> <span class="status-badge bg-proceso">En preparación</span></div>
            <div class="pedido-meta"><span>Carlos Mendoza</span> <span>$150.00</span></div>
          </div>
          <div class="pedido-card-mini" onclick="cargarDetallePedido(923150)">
            <div class="pedido-header"><span>Pedido #923150</span> <span class="status-badge bg-camino">En camino</span></div>
            <div class="pedido-meta"><span>Sofía Reyes</span> <span>$95.50</span></div>
          </div>
        </div>

        <!-- Columna Derecha: Detalle -->
        <div class="pedidos-detalle-cont" id="detallePedidoArea">
          <!-- Cargar el primero por defecto -->
          ${getDetalleHTML(923153)}
        </div>
      </div>
    `;
    document.getElementById('contenido').innerHTML = html;
  }

  // Datos simulados fijos (sin generador)
  const pedidosData = {
    923153: { id: 923153, cliente: "Ana García", tel: "4491234567", status: "Recibido", items: [{n:"Gelatina de frutas", p:11.99, q:2}], total: 23.98 },
    923152: { id: 923152, cliente: "Carlos Mendoza", tel: "4498765432", status: "En preparación", items: [{n:"Pastel de Chocolate", p:150.00, q:1}], total: 150.00 },
    923150: { id: 923150, cliente: "Sofía Reyes", tel: "4491112222", status: "En camino", items: [{n:"Cheesecake Fresa", p:60.00, q:1}, {n:"Caja Galletas", p:35.50, q:1}], total: 95.50 }
  };

  function cargarDetallePedido(id) {
    document.getElementById('detallePedidoArea').innerHTML = getDetalleHTML(id);
    document.querySelectorAll('.pedido-card-mini').forEach(el => el.classList.remove('active'));
  }

  function getDetalleHTML(id) {
    const p = pedidosData[id];
    if(!p) return '';
    let itemsHtml = p.items.map(i => `<li>(${i.q}x) ${i.n} - <strong>$${(i.p * i.q).toFixed(2)}</strong></li>`).join('');
    return `
      <div class="pedido-detalle">
        <h3 style="margin-top:0; color:#b33f4f;">Detalle Pedido #${p.id}</h3>
        <p><strong>Cliente:</strong> ${p.cliente} <br><small style="color:#666">${p.tel}</small></p>
        <div style="background:#f9f9f9; padding:10px; border-radius:6px; margin:15px 0;">
          <ul style="margin:0; padding-left:20px;">${itemsHtml}</ul>
          <p style="text-align:right; margin:5px 0 0; font-weight:bold;">Total: $${p.total.toFixed(2)}</p>
        </div>
        <h4>Estado Actual: <span class="status-badge bg-recibido">${p.status}</span></h4>
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
          <button class="btn-editar" onclick="simularActualizacion()">Avanzar Estado</button>
          <button class="btn-eliminar" onclick="simularCancelacion()">Cancelar Pedido</button>
        </div>
      </div>
    `;
  }

  function simularActualizacion() {
    showModal("El estado del pedido ha sido actualizado (Simulación).", "Actualizado", "✅");
  }
  
  function simularCancelacion() {
    showConfirmation("¿Seguro que deseas cancelar este pedido?").then(yes => {
      if(yes) showModal("Pedido cancelado (Simulación).", "Cancelado", "ℹ️", true);
    });
  }

  // =========================================
  // 3. MÉTRICAS (Reparadas y Locales)
  // =========================================
  function mostrarMetricas() {
    // Generar datos aleatorios para que siempre se vea vivo
    const visitas = Math.floor(Math.random() * 5000) + 3000;
    const pedidos = Math.floor(visitas * 0.08);
    const conversion = ((pedidos/visitas)*100).toFixed(2);
    
    let html = `
      <p class="titulo-contenido">Panel de Métricas</p>
      <div class="kpis">
        <div class="kpi"><div class="label">Visitas (30d)</div><div class="value">${visitas.toLocaleString()}</div></div>
        <div class="kpi"><div class="label">Pedidos</div><div class="value">${pedidos}</div></div>
        <div class="kpi"><div class="label">Tasa Conversión</div><div class="value">${conversion}%</div></div>
        <div class="kpi"><div class="label">Ingresos Aprox.</div><div class="value">$${(pedidos * 120).toLocaleString()}</div></div>
      </div>
      
      <div class="charts">
        <div class="chart-wrap">
          <canvas id="chartVisitas" height="250"></canvas>
        </div>
        <div class="chart-wrap">
          <canvas id="chartCanales" height="250"></canvas>
        </div>
      </div>
    `;
    document.getElementById('contenido').innerHTML = html;

    // Renderizar gráficos con Chart.js
    setTimeout(() => {
      // Destruir instancias previas si existen (para evitar errores de canvas en reuso)
      if(window.myChart1) window.myChart1.destroy();
      if(window.myChart2) window.myChart2.destroy();

      const ctx1 = document.getElementById('chartVisitas');
      if(ctx1) {
        window.myChart1 = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
            datasets: [{
              label: 'Visitas',
              data: [1200, 1900, 1500, 2200],
              borderColor: '#d6001c',
              backgroundColor: 'rgba(214,0,28,0.1)',
              tension: 0.3, fill: true
            }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: { y: { beginAtZero: true } }
          }
        });
      }

      const ctx2 = document.getElementById('chartCanales');
      if(ctx2) {
        window.myChart2 = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: ['Instagram', 'Facebook', 'Directo', 'Google'],
            datasets: [{
              data: [45, 30, 15, 10],
              backgroundColor: ['#E1306C', '#4267B2', '#d6001c', '#F4B400']
            }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
          }
        });
      }
    }, 100);
  }

  // =========================================
  // 4. GESTIÓN DE PRODUCTOS Y USUARIOS (Backend Real)
  // =========================================
  function mostrarProductos() {
    fetch('listar_postres.php')
      .then(res => res.json())
      .then(data => {
        let html = `<p class="titulo-contenido">Gestión de Productos</p>
          <table>
            <tr>
              <th>ID</th>
              <th>Título</th>
              <th>Precio</th>
              <th>Categoría</th>
              <th>Tamaño</th>
              <th>Sabor</th>
              <th>Imagen</th>
              <th>Stock</th>
              <th>Acciones</th>
            </tr>`;
        data.forEach(p => {
          html += `
            <tr>
              <td>${p.id}</td>
              <td>${p.titulo}</td>
              <td>$${p.precio}</td>
              <td>${p.categoria || 'N/A'}</td>
              <td>${p.tamanio || 'N/A'}</td>
              <td>${p.sabor || 'N/A'}</td>
              <td>${p.imagen_url ? `<img src="${p.imagen_url}" alt="${p.titulo}" style="max-width:60px; max-height:40px; border-radius:3px;">` : '—'}</td>
              <td>${p.stock}</td>
              <td class="acciones">
                <button class="btn-editar" onclick="abrirModalEditar(${p.id})">Editar</button>
                <button class="btn-eliminar" onclick="eliminarPostre(${p.id})">Eliminar</button>
              </td>
            </tr>`;
        });
        html += `</table>`;
        document.getElementById("contenido").innerHTML = html;
      })
      .catch(err => showModal("Error al cargar productos: " + err, "Error de Red", "❌", true));
  }

  function mostrarFormularioAgregarPostre() {
    document.getElementById("contenido").innerHTML = `
      <p class="titulo-contenido">Agregar Postre Nuevo</p>
      <form id="formAgregarLocal" style="max-width:500px; margin:auto;">
        <label>Título</label><input type="text" name="titulo" required>
        <label>Descripción</label><textarea name="descripcion" rows="3" required></textarea>
        <label>Precio</label><input type="number" step="0.01" name="precio" required>
        <label>Categoría</label><input type="text" name="categoria">
        <label>Tamaño</label><input type="text" name="tamanio"> <!-- RESTAURADO -->
        <label>Sabor</label><input type="text" name="sabor"> <!-- RESTAURADO -->
        <label>URL Imagen</label><input type="text" name="imagen_url">
        <label>Stock</label><input type="number" name="stock">
        <br><br><button type="submit" class="btn-editar" style="width:100%">Agregar</button>
      </form>
    `;
    document.getElementById('formAgregarLocal').addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      try {
        const res = await fetch('crear_postre.php', { method: 'POST', body: fd });
        const msg = await res.text();
        // Avisos reemplazados por modales
        await showModal(msg, "Resultado", "✅");
        mostrarProductos();
      } catch(err) { showModal(err, "Error de Red", "❌", true); }
    });
  }

  async function eliminarPostre(id) {
    // Confirmación reemplazada por modal
    if(await showConfirmation("¿Está seguro de que desea eliminar este postre permanentemente? Esta acción no se puede deshacer.")) {
      const fd = new FormData(); fd.append('id', id);
      const res = await fetch('eliminar_postre.php', { method: 'POST', body: fd });
      const msg = await res.text();
      // Avisos reemplazados por modales
      await showModal(msg, "Aviso", "ℹ️");
      mostrarProductos();
    }
  }

  function abrirModalEditar(id) {
    fetch(`listar_postre_individual.php?id=${id}`).then(r=>r.json()).then(p=>{
      if(p.error){ showModal(p.error, "Error de Carga", "❌", true); return; }
      document.getElementById('editar_id').value = p.id;
      document.getElementById('editar_titulo').value = p.titulo;
      document.getElementById('editar_descripcion').value = p.descripcion;
      document.getElementById('editar_precio').value = p.precio;
      document.getElementById('editar_categoria').value = p.categoria;
      document.getElementById('editar_tamanio').value = p.tamanio;
      document.getElementById('editar_sabor').value = p.sabor;
      document.getElementById('editar_imagen_url').value = p.imagen_url;
      document.getElementById('editar_stock').value = p.stock;
      document.getElementById('modalEditar').style.display = 'flex';
    });
  }

  function mostrarUsuarios() {
    fetch('listar_usuarios.php').then(r=>r.json()).then(data=>{
      let html = `<p class="titulo-contenido">Gestión de Usuarios</p>
        <table><tr><th>ID</th><th>Correo</th><th>Acciones</th></tr>`;
      data.forEach(u => {
        html += `<tr><td>${u.id}</td><td>${u.correo}</td>
          <td class="acciones">
            <button class="btn-editar" onclick="abrirModalUsuario(${u.id})">Editar</button>
            <button class="btn-eliminar" onclick="eliminarUsuario(${u.id})">Eliminar</button>
          </td></tr>`;
      });
      html += `</table>`;
      document.getElementById('contenido').innerHTML = html;
    });
  }

  async function eliminarUsuario(id) {
    // Confirmación reemplazada por modal
    if(await showConfirmation("¿Está seguro de que desea eliminar este usuario permanentemente?")) {
      const fd = new FormData(); fd.append('id', id);
      fetch('eliminar_usuario.php', {method:'POST', body:fd}).then(r=>r.json()).then(resp=>{
        showModal(resp.msg, "Aviso", resp.ok?"✅":"❌", !resp.ok);
        if(resp.ok) mostrarUsuarios();
      });
    }
  }

  function abrirModalUsuario(id) {
    fetch(`listar_usuario_individual.php?id=${id}`).then(r=>r.json()).then(u=>{
      document.getElementById('usuario_id').value = u.id;
      document.getElementById('usuario_correo').value = u.correo;
      document.getElementById('modalEditarUsuario').style.display = 'flex';
    });
  }

  function cerrarModalesEdicion() {
    document.getElementById('modalEditar').style.display = 'none';
    document.getElementById('modalEditarUsuario').style.display = 'none';
  }

  // Listeners Edición
  document.addEventListener('DOMContentLoaded', () => {
    // Postre
    const fP = document.getElementById('formEditarPostre');
    if(fP) fP.addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const res = await fetch('editar_postre.php', { method: 'POST', body: fd });
      const msg = await res.text();
      // Avisos reemplazados por modales
      await showModal(msg, "Resultado", "✅");
      cerrarModalesEdicion();
      mostrarProductos();
    });

    // Usuario
    const fU = document.getElementById('formEditarUsuario');
    if(fU) fU.addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const res = await fetch('editar_usuario.php', { method: 'POST', body: fd });
      const resp = await res.json();
      // Avisos reemplazados por modales
      await showModal(resp.msg, "Resultado", resp.ok?"✅":"❌", !resp.ok);
      if(resp.ok){ cerrarModalesEdicion(); mostrarUsuarios(); }
    });
  });

</script>
</body>
</html>